#!/bin/bash -x
source /etc/profile

echo "getting environment information"
echo $LE_ENVIRONMENT
echo $LE_STACK
echo $STACK_PROFILE
echo $INSTALL_MODE

echo "copying files"
cd /tmp/le-ui
tar xzf le-ui.tar.gz

cd le-ui
cp -rf . /opt/node/latest

cat ${STACK_PROFILE}
ls conf/env/${LE_ENVIRONMENT}
python /tmp/le-ui/replace_token.py /opt/node/latest/conf/env/${LE_ENVIRONMENT} ${STACK_PROFILE}

cp /opt/node/latest/conf/env/${LE_ENVIRONMENT}/ENV_VARS /opt/node/latest

if [ "${INSTALL_MODE}" == "EXTERNAL" ]; then
    sed -i "s|{{NODE_APPS}}|leui|g" /opt/node/latest
else
    sed -i "s|{{NODE_APPS}}|leadmin|g" /opt/node/latest
fi

chmod -R 755 /opt/node/latest

echo "cleaning up"
rm -rf /tmp/le-ui
rm -rf /opt/node/latest/conf
cat /opt/node/latest/ENV_VARS