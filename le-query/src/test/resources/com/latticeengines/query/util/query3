with temptrxn as (select AccountId, PeriodId, ProductId, TotalAmount, TotalQuantity
from Query_Test_AggregatedPeriodTransaction_3
where PeriodName = 'Month'), tempkeys (AccountId, PeriodId) as (select crossprod.AccountId, PeriodId
from (select AccountId, PeriodId
from (select distinct AccountId
from temptrxn) as allaccounts, (select distinct PeriodId
from temptrxn) as allperiods) as crossprod
inner join (select AccountId, min(PeriodId) as minpid
from temptrxn
group by AccountId) as periodrange
on periodrange.AccountId = crossprod.AccountId
where crossprod.PeriodId >= periodrange.minpid - 2), apsg4XYehUl (AccountId, PeriodId, amountagg, quantityagg) as (select AccountId, PeriodId, amountagg, quantityagg
from (select tempkeys.AccountId, tempkeys.PeriodId, sum(coalesce(trxn.amountval, 0)) over (partition by tempkeys.AccountId order by tempkeys.PeriodId asc rows between unbounded preceding and current row) as amountagg, sum(coalesce(trxn.quantityval, 0)) over (partition by tempkeys.AccountId order by tempkeys.PeriodId asc rows between unbounded preceding and current row) as quantityagg
from tempkeys
left join (select AccountId, PeriodId, TotalAmount as amountval, TotalQuantity as quantityval
from temptrxn
where ProductId = 'eNm3Nmt72BXLZRniXJWSFO4j2jnOUpY') as trxn
on tempkeys.AccountId = trxn.AccountId and tempkeys.PeriodId = trxn.PeriodId) as aps
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), apsgF642jRg (AccountId, PeriodId, amountagg, quantityagg) as (select *
from (select *
from apsg4XYehUl)), apsccAg5aiq (AccountId, PeriodId, amountagg, quantityagg) as (select AccountId, PeriodId, (case when amountagg is null then 0 else amountagg end) as amountagg, (case when quantityagg is null then 0 else quantityagg end) as quantityagg
from apsgF642jRg), TransactionttQSo6Ej (AccountId, PeriodId) as (select AccountId, PeriodId
from apsgF642jRg
group by AccountId, PeriodId
having sum(amountagg) > 0 and sum(quantityagg) > 0), AccountmoFiwoNy (AccountId) as (select Account.AccountId
from Query_Test_BucketedAccount_3 as Account
where lower(Account.City) = lower('HOUSTON')), AccountlwMLasFp (AccountId, PeriodId) as (select tempkeys.AccountId, tempkeys.PeriodId
from tempkeys
join AccountmoFiwoNy
on tempkeys.AccountId = AccountmoFiwoNy.AccountId
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), Account784oZEv8 (AccountId) as (select Account.AccountId
from Query_Test_BucketedAccount_3 as Account
where lower(Account.City) = lower('CHICAGO')), Account9x86D16O (AccountId, PeriodId) as (select tempkeys.AccountId, tempkeys.PeriodId
from tempkeys
join Account784oZEv8
on tempkeys.AccountId = Account784oZEv8.AccountId
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), AccountY2A1GPdm (AccountId) as (select Account.AccountId
from Query_Test_BucketedAccount_3 as Account
left join Query_Test_SortedContact_3 as Contact
on Account.AccountId = Contact.AccountId
where Contact.Email ilike '%' || 'gmail' || '%'), Accounth5ajKOvn (AccountId, PeriodId) as (select tempkeys.AccountId, tempkeys.PeriodId
from tempkeys
join AccountY2A1GPdm
on tempkeys.AccountId = AccountY2A1GPdm.AccountId
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), AccountxX9LdQN4 (AccountId) as (select Account.AccountId
from Query_Test_BucketedAccount_3 as Account
left join Query_Test_SortedContact_3 as Contact
on Account.AccountId = Contact.AccountId
where Contact.Email ilike '%' || 'hotmail' || '%'), Accounthq2Scr8w (AccountId, PeriodId) as (select tempkeys.AccountId, tempkeys.PeriodId
from tempkeys
join AccountxX9LdQN4
on tempkeys.AccountId = AccountxX9LdQN4.AccountId
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), LogicalEhWurvj9 (AccountId, PeriodId) as ((select *
from AccountlwMLasFp)
union
(select *
from Account9x86D16O)), LogicalZI3qvtYE (AccountId, PeriodId) as ((select *
from Accounth5ajKOvn)
union
(select *
from Accounthq2Scr8w)), LogicalcgoE4sRd (AccountId, PeriodId) as ((select *
from TransactionttQSo6Ej)
intersect
(select *
from LogicalEhWurvj9)
intersect
(select *
from LogicalZI3qvtYE))
select LogicalcgoE4sRd.AccountId, LogicalcgoE4sRd.PeriodId
from LogicalcgoE4sRd
where PeriodId > 0
