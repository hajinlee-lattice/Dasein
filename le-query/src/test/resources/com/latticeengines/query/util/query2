with temptrxn as (select AccountId, PeriodId, ProductId, TotalAmount, TotalQuantity
from Query_Test_AggregatedPeriodTransaction_3
where PeriodName = 'Month'), tempkeys (AccountId, PeriodId) as (select crossprod.AccountId, PeriodId
from (select AccountId, PeriodId
from (select distinct AccountId
from temptrxn) as allaccounts, (select distinct PeriodId
from temptrxn) as allperiods) as crossprod
inner join (select AccountId, min(PeriodId) as minpid
from temptrxn
group by AccountId) as periodrange
on periodrange.AccountId = crossprod.AccountId
where crossprod.PeriodId >= periodrange.minpid - 2), apskBNfzvtZ (AccountId, PeriodId, amountagg, quantityagg) as (select AccountId, PeriodId, amountagg, quantityagg
from (select tempkeys.AccountId, tempkeys.PeriodId, sum(coalesce(trxn.amountval, 0)) over (partition by tempkeys.AccountId order by tempkeys.PeriodId asc rows between unbounded preceding and current row) as amountagg, sum(coalesce(trxn.quantityval, 0)) over (partition by tempkeys.AccountId order by tempkeys.PeriodId asc rows between unbounded preceding and current row) as quantityagg
from tempkeys
left join (select AccountId, PeriodId, TotalAmount as amountval, TotalQuantity as quantityval
from temptrxn
where ProductId = 'eNm3Nmt72BXLZRniXJWSFO4j2jnOUpY') as trxn
on tempkeys.AccountId = trxn.AccountId and tempkeys.PeriodId = trxn.PeriodId) as aps
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), apsP3iihQKX (AccountId, PeriodId, amountagg, quantityagg) as (select *
from (select *
from apskBNfzvtZ)), apsw3Jo8nOP (AccountId, PeriodId, amountagg, quantityagg) as (select AccountId, PeriodId, (case when amountagg is null then 0 else amountagg end) as amountagg, (case when quantityagg is null then 0 else quantityagg end) as quantityagg
from apsP3iihQKX), TransactionxU9ZjYOc (AccountId, PeriodId) as (select AccountId, PeriodId
from apsP3iihQKX
group by AccountId, PeriodId
having sum(amountagg) > 0 and sum(quantityagg) > 0), AccountwCQEldZ0 (AccountId) as (select Account.AccountId
from Query_Test_BucketedAccount_3 as Account
where lower(Account.City) = lower('HOUSTON')), AccountkjqA9qIu (AccountId, PeriodId) as (select tempkeys.AccountId, tempkeys.PeriodId
from tempkeys
join AccountwCQEldZ0
on tempkeys.AccountId = AccountwCQEldZ0.AccountId
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), Account261o9KAe (AccountId) as (select Account.AccountId
from Query_Test_BucketedAccount_3 as Account
where lower(Account.City) = lower('CHICAGO')), AccountQBV9Ymff (AccountId, PeriodId) as (select tempkeys.AccountId, tempkeys.PeriodId
from tempkeys
join Account261o9KAe
on tempkeys.AccountId = Account261o9KAe.AccountId
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), AccountMfrtEzXA (AccountId) as (select Account.AccountId
from Query_Test_BucketedAccount_3 as Account
left join Query_Test_SortedContact_3 as Contact
on Account.AccountId = Contact.AccountId
where Contact.Email ilike '%' || 'gmail' || '%'), AccountRF6UBrWb (AccountId, PeriodId) as (select tempkeys.AccountId, tempkeys.PeriodId
from tempkeys
join AccountMfrtEzXA
on tempkeys.AccountId = AccountMfrtEzXA.AccountId
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), AccountAw9E2dfv (AccountId) as (select Account.AccountId
from Query_Test_BucketedAccount_3 as Account
left join Query_Test_SortedContact_3 as Contact
on Account.AccountId = Contact.AccountId
where Contact.Email ilike '%' || 'hotmail' || '%'), AccountGGTeHNeo (AccountId, PeriodId) as (select tempkeys.AccountId, tempkeys.PeriodId
from tempkeys
join AccountAw9E2dfv
on tempkeys.AccountId = AccountAw9E2dfv.AccountId
where PeriodId = (select max(temptrxn.PeriodId) as maxpid
from temptrxn)), LogicalCXkur8UX (AccountId, PeriodId) as ((select *
from AccountkjqA9qIu)
union
(select *
from AccountQBV9Ymff)), Logical4rhHaMg9 (AccountId, PeriodId) as ((select *
from AccountRF6UBrWb)
union
(select *
from AccountGGTeHNeo)), LogicalTbIgVBLZ (AccountId, PeriodId) as ((select *
from TransactionxU9ZjYOc)
intersect
(select *
from LogicalCXkur8UX)
intersect
(select *
from Logical4rhHaMg9))
select LogicalTbIgVBLZ.AccountId, LogicalTbIgVBLZ.PeriodId
from LogicalTbIgVBLZ
where PeriodId > 0
