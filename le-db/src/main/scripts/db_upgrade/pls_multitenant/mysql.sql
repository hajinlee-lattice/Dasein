CREATE PROCEDURE `UpdateCDLTables`()
    BEGIN

    ALTER TABLE `PLS_MultiTenant`.`BUCKET_METADATA` ADD COLUMN `RATING_ENGINE_ID` bigint;
        
    ALTER TABLE `PLS_MultiTenant`.`BUCKET_METADATA` add constraint `FK_BUCKETMETADATA_RATINGENGINEID_RATINGENGINE` foreign key (`RATING_ENGINE_ID`) references `RATING_ENGINE` (`PID`) on delete cascade;

    alter table DATAFEED DROP COLUMN `ACTIVE_PROFILE`;
    drop table DATAFEED_PROFILE;
    alter table DATAFEED_EXECUTION ADD COLUMN `JOB_TYPE` varchar(255) not null DEFAULT 'PA';
    UPDATE DATAFEED_EXECUTION SET STATUS = 'Completed' where STATUS = 'ProcessAnalyzed';
    END;
//
DELIMITER ;


CREATE PROCEDURE `AddCDLActivityMetrics`()
    BEGIN
	CREATE TABLE IF NOT EXISTS `CDL_ACTIVITY_METRICS` (
	  `PID` bigint(20) NOT NULL AUTO_INCREMENT,
	  `CREATED` datetime NOT NULL,
	  `DEPRECATED` datetime DEFAULT NULL,
	  `IS_EOL` bit(1) DEFAULT NULL,
	  `METRICS` varchar(100) NOT NULL,
	  `PERIODS` varchar(1000) NOT NULL,
	  `TYPE` varchar(100) NOT NULL,
	  `UPDATED` datetime NOT NULL,
	  `FK_TENANT_ID` bigint(20) NOT NULL,
	  PRIMARY KEY (`PID`),
	  KEY `FK_CDLACTIVITYMETRICS_FKTENANTID_TENANT` (`FK_TENANT_ID`),
	  CONSTRAINT `FK_CDLACTIVITYMETRICS_FKTENANTID_TENANT` FOREIGN KEY (`FK_TENANT_ID`) REFERENCES `TENANT` (`TENANT_PID`) ON DELETE CASCADE
	) ENGINE=InnoDB;
    END
//
DELIMITER ;


DELIMITER //
CREATE PROCEDURE `UpdateSchema`()
    BEGIN
        START TRANSACTION;
        CALL `UpdateCDLTables`();
	CALL `AddCDLActivityMetrics`();
        COMMIT;
    END;
//
DELIMITER ;

CALL `UpdateSchema`();
