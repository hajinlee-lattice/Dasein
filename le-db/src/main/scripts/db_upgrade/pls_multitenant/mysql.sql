USE `PLS_MultiTenant`;

CREATE PROCEDURE `UpdatePLSTables`()
  BEGIN
    ALTER TABLE `PLS_MultiTenant`.`WORKFLOW_JOB`
        ADD COLUMN `CONFIGURATION` JSON NULL DEFAULT NULL,
        ADD COLUMN `STACK` VARCHAR(10) NULL DEFAULT NULL;

    ALTER TABLE `PLS_MultiTenant`.`PLAY_LAUNCH_CHANNEL`
        ADD COLUMN `CURRENT_LAUNCHED_ACCOUNT_UNIVERSE_TABLE_ID` varchar(255),
        ADD COLUMN `CURRENT_LAUNCHED_CONTACT_UNIVERSE_TABLE_ID` varchar(255);

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH_CHANNEL` c
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON c.FK_CURRENT_LAUNCHED_ACCOUNT_UNIVERSE_TABLE = t.PID
        SET c.CURRENT_LAUNCHED_ACCOUNT_UNIVERSE_TABLE_ID = t.NAME;

	create table `EXPORT_FIELD_METADATA_MAPPING`
		(`PID` bigint not null auto_increment,
		`CREATED` datetime not null,
		`DESTINATION_FIELD` varchar(255) not null,
		`OVERWRITE_VALUE` bit not null,
		`SOURCE_FIELD` varchar(255) not null,
		`UPDATED` datetime not null,
		`FK_LOOKUP_ID_MAP` bigint not null,
		`FK_TENANT_ID` bigint not null,
		primary key (`PID`)) engine=InnoDB;

	ALTER TABLE `EXPORT_FIELD_METADATA_MAPPING`
	    ADD CONSTRAINT `FK_EXPORTFIELDMETADATAMAPPING_FKLOOKUPIDMAP_LOOKUPIDMAP`
	        FOREIGN KEY (`FK_LOOKUP_ID_MAP`) REFERENCES `LOOKUP_ID_MAP` (`PID`) ON DELETE CASCADE,
        ADD CONSTRAINT `FK_EXPORTFIELDMETADATAMAPPING_FKTENANTID_TENANT`
            FOREIGN KEY (`FK_TENANT_ID`) REFERENCES `TENANT` (`TENANT_PID`) ON DELETE CASCADE;


    ALTER TABLE `PLS_MultiTenant`.`DATAFEED`
        ADD COLUMN `SCHEDULING_GROUP` VARCHAR(20) NULL DEFAULT 'Default' AFTER `FK_TENANT_ID`;

	ALTER TABLE `PLS_MultiTenant`.`METADATA_SEGMENT` ADD COLUMN `UPDATED_BY` VARCHAR(255);
	ALTER TABLE `PLS_MultiTenant`.`RATING_ENGINE` ADD COLUMN `UPDATED_BY` VARCHAR(255);
	ALTER TABLE `PLS_MultiTenant`.`RATING_MODEL` ADD COLUMN `UPDATED_BY` VARCHAR(255);
	ALTER TABLE `PLS_MultiTenant`.`RATING_ENGINE` ADD COLUMN `DESCRIPTION` VARCHAR(255);

	ALTER TABLE `PLS_MultiTenant`.`BUCKET_METADATA`
	    ADD COLUMN `ORIG_CREATION_TIMESTAMP` BIGINT(20) NULL DEFAULT NULL AFTER `CREATION_TIMESTAMP`;

	CREATE TABLE `IMPORT_MIGRATE_TRACKING` (
      `PID` bigint(20) NOT NULL AUTO_INCREMENT,
      `REPORT` json DEFAULT NULL,
      `STATUS` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
      `FK_TENANT_ID` bigint(20) NOT NULL,
      PRIMARY KEY (`PID`),
      KEY `FK_TENANT_ID` (`FK_TENANT_ID`),
      CONSTRAINT `IMPORT_MIGRATE_TRACKING_ibfk_1` FOREIGN KEY (`FK_TENANT_ID`) REFERENCES `TENANT` (`TENANT_PID`) ON DELETE CASCADE
    ) ENGINE=InnoDB;

    CREATE TABLE `MIGRATION_TRACK` (
      `PID` bigint(20) NOT NULL AUTO_INCREMENT,
      `STATUS` varchar(45) COLLATE utf8mb4_unicode_ci NOT NULL,
      `VERSION` varchar(45) COLLATE utf8mb4_unicode_ci NOT NULL,
      `CUR_ACTIVE_TABLE_NAME` json DEFAULT NULL COMMENT 'DataCollectionTable.ROLE -> list of Table.NAME',
      `FK_IMPORT_TRACKING` bigint(20) DEFAULT NULL COMMENT 'IMPORT_MIGRATE_TRACKING.pid',
      `DETAIL` json DEFAULT NULL COMMENT 'from DATA_COLLECTION_STATUS.Detail',
      `CUBES_DATA` longblob COMMENT 'from STATISTICS.CUBES_DATA',
      `NAME` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'from STATISTICS.NAME',
      `FK_TENANT_ID` bigint(20) NOT NULL,
      `FK_COLLECTION_ID` bigint(20) DEFAULT NULL,
      PRIMARY KEY (`PID`),
      KEY `FK_IMPORT_TRACKING` (`FK_IMPORT_TRACKING`),
      KEY `FK_TENANT_ID` (`FK_TENANT_ID`),
      KEY `FK_COLLECTION_ID` (`FK_COLLECTION_ID`),
      CONSTRAINT `MIGRATION_TRACK_ibfk_1` FOREIGN KEY (`FK_IMPORT_TRACKING`) REFERENCES `IMPORT_MIGRATE_TRACKING` (`PID`),
      CONSTRAINT `MIGRATION_TRACK_ibfk_2` FOREIGN KEY (`FK_TENANT_ID`) REFERENCES `TENANT` (`TENANT_PID`) ON DELETE CASCADE,
      CONSTRAINT `MIGRATION_TRACK_ibfk_3` FOREIGN KEY (`FK_COLLECTION_ID`) REFERENCES `METADATA_DATA_COLLECTION` (`PID`)
    ) ENGINE=InnoDB;

    ALTER TABLE `PLS_MultiTenant`.`ATLAS_EXPORT` ADD COLUMN `APPLICATION_ID` VARCHAR(255),
		ADD COLUMN `CREATED_BY` VARCHAR(255),
		ADD COLUMN `ACCOUNT_RESTRICTION` LONGTEXT,
		ADD COLUMN `CONTACT_RESTRICTION` LONGTEXT,
		ADD COLUMN `SCHEDULED` BIT NOT NULL DEFAULT 1,
		ADD COLUMN `CLEANUP_BY` DATETIME NOT NULL DEFAULT '1970-01-01 00:00:00',
		ADD COLUMN `STATUS` VARCHAR(255) NOT NULL DEFAULT 'COMPLETED',
		ADD COLUMN `SEGMENT_NAME` VARCHAR(255),
		ADD COLUMN `FILES_TO_DELETE` JSON,
		ADD COLUMN `CREATED` DATETIME NOT NULL DEFAULT '1970-01-01 00:00:00',
		ADD COLUMN `UPDATED` DATETIME NOT NULL DEFAULT '1970-01-01 00:00:00';

    CREATE TABLE `CONVERT_BATCHSTORE_INFO`
      (
         `PID`            BIGINT NOT NULL auto_increment,
         `CONVERT_DETAIL` JSON,
         `FK_TENANT_ID`   BIGINT NOT NULL,
         PRIMARY KEY (`PID`)
      )
    engine=InnoDB;

    ALTER TABLE `CONVERT_BATCHSTORE_INFO`
      ADD CONSTRAINT `FK_CONVERTBATCHSTOREINFO_FKTENANTID_TENANT` FOREIGN KEY (
      `FK_TENANT_ID`) REFERENCES `TENANT` (`TENANT_PID`) ON DELETE CASCADE;

    ALTER TABLE `PLS_MultiTenant`.`WORKFLOW_JOB`
      ADD COLUMN `STACK` VARCHAR(10) NULL DEFAULT NULL AFTER `TYPE`;


      ALTER TABLE `PLS_MultiTenant`.`PLAY_LAUNCH` ADD COLUMN `AUDIENCE_SIZE` bigint;
      ALTER TABLE `PLS_MultiTenant`.`PLAY_LAUNCH` ADD COLUMN `MATCHED_COUNT` bigint;

    CREATE TABLE `ATLAS_CATALOG` (
      `PID` BIGINT NOT NULL AUTO_INCREMENT,
      `NAME` VARCHAR(255) COLLATE utf8mb4_unicode_ci NOT NULL,
      `CREATED` DATETIME NOT NULL,
      `UPDATED` DATETIME NOT NULL,
      `FK_TENANT_ID` bigint(20) NOT NULL,
      `FK_TASK_ID` BIGINT(20) NOT NULL,
      PRIMARY KEY (`PID`),
      KEY `FK_TENANT_ID` (`FK_TENANT_ID`),
      KEY `FK_TASK_ID` (`FK_TASK_ID`),
      UNIQUE KEY `UK_NAME_TENANT` (`NAME`,`FK_TENANT_ID`),
      UNIQUE KEY `UK_TASK_TENANT` (`FK_TASK_ID`,`FK_TENANT_ID`),
      CONSTRAINT `CATALOG_FK_TENANT` FOREIGN KEY (`FK_TENANT_ID`) REFERENCES `TENANT` (`TENANT_PID`) ON DELETE CASCADE,
      CONSTRAINT `CATALOG_FK_DATAFEED_TASK` FOREIGN KEY (`FK_TASK_ID`) REFERENCES `DATAFEED_TASK` (`PID`) ON DELETE CASCADE
    ) engine=InnoDB;

    ALTER TABLE `PLS_MultiTenant`.`PLAY_LAUNCH`
        ADD COLUMN `ADD_ACCOUNTS_TABLE_NAME` varchar(255),
        ADD COLUMN `ADD_CONTACTS_TABLE_NAME` varchar(255),
        ADD COLUMN `REMOVE_ACCOUNTS_TABLE_NAME` varchar(255),
        ADD COLUMN `REMOVE_CONTACTS_TABLE_NAME` varchar(255),
        ADD COLUMN `AUDIENCE_SIZE` bigint,
        ADD COLUMN `MATCHED_COUNT` bigint;

    ALTER TABLE `PLS_MultiTenant`.`ATLAS_EXPORT` ADD COLUMN `APPLICATION_ID` VARCHAR(255),
		ADD COLUMN `CREATED_BY` VARCHAR(255),
		ADD COLUMN `ACCOUNT_RESTRICTION` LONGTEXT,
		ADD COLUMN `CONTACT_RESTRICTION` LONGTEXT,
		ADD COLUMN `SCHEDULED` BIT NOT NULL DEFAULT 1,
		ADD COLUMN `CLEANUP_BY` DATETIME NOT NULL DEFAULT '1970-01-01 00:00:00',
		ADD COLUMN `STATUS` VARCHAR(255) NOT NULL DEFAULT 'COMPLETED',
		ADD COLUMN `SEGMENT_NAME` VARCHAR(255),
		ADD COLUMN `FILES_TO_DELETE` JSON,
		ADD COLUMN `CREATED` DATETIME NOT NULL DEFAULT '1970-01-01 00:00:00',
		ADD COLUMN `UPDATED` DATETIME NOT NULL DEFAULT '1970-01-01 00:00:00';

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH` l
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON l.FK_ADD_ACCOUNTS_TABLE = t.PID
        SET l.ADD_ACCOUNTS_TABLE_NAME = t.NAME;

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH` l
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON l.FK_ADD_CONTACTS_TABLE = t.PID
        SET l.ADD_CONTACTS_TABLE_NAME = t.NAME;

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH` l
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON l.FK_REMOVE_ACCOUNTS_TABLE = t.PID
        SET l.REMOVE_ACCOUNTS_TABLE_NAME = t.NAME;

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH` l
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON l.FK_REMOVE_CONTACTS_TABLE = t.PID
        SET l.REMOVE_CONTACTS_TABLE_NAME = t.NAME;

    ALTER TABLE `PLS_MultiTenant`.`METADATA_DATA_COLLECTION_TABLE`
        ADD COLUMN `SIGNATURE` VARCHAR(255) NULL DEFAULT NULL AFTER `ROLE`,
        ADD UNIQUE KEY `UK_COLLECTION_ROLE_VERSION_SIGNATURE` (`FK_COLLECTION_ID`, `ROLE`, `VERSION`, `SIGNATURE`);

    CREATE TABLE `PLS_MultiTenant`.`ATLAS_CATALOG`
    (
      `PID` BIGINT NOT NULL AUTO_INCREMENT,
      `NAME` VARCHAR(255) COLLATE utf8mb4_unicode_ci NOT NULL,
      `CREATED` DATETIME NOT NULL,
      `UPDATED` DATETIME NOT NULL,
      `FK_TENANT_ID` bigint(20) NOT NULL,
      `FK_TASK_ID` BIGINT(20) NOT NULL,
      PRIMARY KEY (`PID`),
      KEY `FK_TENANT_ID` (`FK_TENANT_ID`),
      KEY `FK_TASK_ID` (`FK_TASK_ID`),
      UNIQUE KEY `UK_NAME_TENANT` (`NAME`,`FK_TENANT_ID`),
      UNIQUE KEY `UK_TASK_TENANT` (`FK_TASK_ID`,`FK_TENANT_ID`),
      CONSTRAINT `CATALOG_FK_TENANT` FOREIGN KEY (`FK_TENANT_ID`) REFERENCES `TENANT` (`TENANT_PID`) ON DELETE CASCADE,
      CONSTRAINT `CATALOG_FK_DATAFEED_TASK` FOREIGN KEY (`FK_TASK_ID`) REFERENCES `DATAFEED_TASK` (`PID`) ON DELETE CASCADE
    ) engine=InnoDB;
  END;
//
DELIMITER;

CALL `UpdatePLSTables`();
