USE `PLS_MultiTenant`;

CREATE PROCEDURE `CreateDCPProjectTable`()
  BEGIN
    CREATE TABLE `DCP_PROJECT`
      (
         `PID`                  BIGINT NOT NULL auto_increment,
         `CREATED`              DATETIME NOT NULL,
         `CREATED_BY`           VARCHAR(255) NOT NULL,
         `DELETED`              BIT,
         `PROJECT_DESCRIPTION`  VARCHAR(4000),
         `PROJECT_DISPLAY_NAME` VARCHAR(255),
         `PROJECT_ID`           VARCHAR(255) NOT NULL,
         `PROJECT_TYPE`         VARCHAR(255),
         `ROOT_PATH`            VARCHAR(255),
         `UPDATED`              DATETIME NOT NULL,
         `FK_TENANT_ID`         BIGINT NOT NULL,
         PRIMARY KEY (`PID`)
      )
    engine=InnoDB;

    CREATE INDEX IX_PROJECT_ID ON `DCP_PROJECT` (`PROJECT_ID`);

    ALTER TABLE `DCP_PROJECT`
      ADD CONSTRAINT UX_PROJECT_ID UNIQUE (`FK_TENANT_ID`, `PROJECT_ID`);

    ALTER TABLE `DCP_PROJECT`
      ADD CONSTRAINT `FK_DCPPROJECT_FKTENANTID_TENANT` FOREIGN KEY (`FK_TENANT_ID`)
      REFERENCES `TENANT` (`TENANT_PID`) ON DELETE CASCADE;
  END;

CREATE PROCEDURE `UpdatePLSTables`()
  BEGIN
    ALTER TABLE `PLS_MultiTenant`.`DANTE_PUBLISHEDTALKINGPOINT`
        ADD COLUMN `PLAY_ID` BIGINT NOT NULL,
        ADD CONSTRAINT `FK_DANTEPUBLISHEDTALKINGPOINT_PLAYID_PLAY` FOREIGN KEY (`PLAY_ID`) REFERENCES `PLAY` (`PID`) ON DELETE CASCADE;

    UPDATE `PLS_MultiTenant`.`DANTE_PUBLISHEDTALKINGPOINT` T1
        INNER JOIN `PLS_MultiTenant`.`PLAY` T2 ON T1.PLAY_NAME = T2.NAME
        SET T1.`PLAY_ID` = T2.`PID`;

    ALTER TABLE `PLAY_LAUNCH`
        ADD COLUMN `LAUNCH_TYPE` VARCHAR(255) NOT NULL DEFAULT 'FULL',
        ADD COLUMN `DESTINATION_SYS_NAME` VARCHAR(255) AFTER `DESTINATION_SYS_TYPE`;

    UPDATE PLAY_LAUNCH pl
    	LEFT JOIN PLAY_LAUNCH_CHANNEL c ON c.PID = pl.FK_PLAY_LAUNCH_CHANNEL_ID
        LEFT JOIN LOOKUP_ID_MAP l ON l.PID = c.FK_LOOKUP_ID_MAP_ID
    SET pl.DESTINATION_SYS_NAME = l.EXT_SYS_NAME;

    ALTER TABLE `PLS_MultiTenant`.`METADATA_SEGMENT` ADD COLUMN `COUNTS_OUTDATED` BIT NULL DEFAULT 0;


  END;

DELIMITER;
