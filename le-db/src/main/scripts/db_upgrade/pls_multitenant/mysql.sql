USE `PLS_MultiTenant`;

DROP PROCEDURE IF EXISTS `UpdateSchema`;

DELIMITER //
CREATE PROCEDURE `UpdateSchema` ()
  BEGIN
    ALTER TABLE `METADATA_TABLE` ADD `NAMESPACE` VARCHAR(255);

    CREATE TABLE `METADATA_TABLE_TAG` (
        `PID`       BIGINT          NOT NULL AUTO_INCREMENT UNIQUE, 
        `NAME`      VARCHAR(255)    NOT NULL, 
        `TENANT_ID` BIGINT          NOT NULL, 
        FK_TABLE_ID BIGINT          NOT NULL, 
        PRIMARY KEY (`PID`))
        ENGINE=InnoDB;

    ALTER TABLE `METADATA_TABLE_TAG
        ADD INDEX FK6BACA6595FC50F27 (FK_TABLE_ID),
        ADD CONSTRAINT FK6BACA6595FC50F27 FOREIGN KEY (FK_TABLE_ID) REFERENCES `METADATA_TABLE` (`PID`) ON DELETE CASCADE;

    

    CREATE TABLE `METADATA_STORAGE` (
        `NAME`          VARCHAR(31)   NOT NULL, 
        `PID`           BIGINT        NOT NULL AUTO_INCREMENT UNIQUE, 
        `TABLE_NAME`    VARCHAR(255)  NOT NULL, 
        `DATABASE_NAME` INTEGER, 
        FK_TABLE_ID     BIGINT        NOT NULL, 
        PRIMARY KEY (`PID`))
        ENGINE=InnoDB;

    ALTER TABLE `METADATA_STORAGE`
        ADD INDEX FKAAD4414B5FC50F27 (FK_TABLE_ID)
        ADD CONSTRAINT FKAAD4414B5FC50F27 FOREIGN KEY (FK_TABLE_ID) REFERENCES `METADATA_TABLE` ON DELETE CASCADE;
  

    INSERT INTO `METADATA_STORAGE` (NAME, TABLE_NAME, FK_TABLE_ID)
        SELECT 'HDFS', NAME, PID FROM `METADATA_TABLE`;
  END //
DELIMITER ;

CALL `UpdateSchema`() ;



