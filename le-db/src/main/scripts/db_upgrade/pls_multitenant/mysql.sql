USE `PLS_MultiTenant`;

CREATE PROCEDURE `UpdatePLSTables`()
BEGIN
    ALTER TABLE `PLAY_LAUNCH`
      ADD COLUMN `FK_WORKFLOW_ID` bigint,
      ADD COLUMN `FK_DELTA_CALC_WORKFLOW_ID` bigint,
      ADD COLUMN `IS_SCHEDULED_LAUNCH` BIT DEFAULT 0 NOT NULL;

    UPDATE `PLAY_LAUNCH`
      SET IS_SCHEDULED_LAUNCH = CASE WHEN CREATED_BY = 'build-admin@lattice-engines.com' THEN 1 ELSE 0 END; -- build@lattice-engines.com for QA

    ALTER TABLE `TENANT` ADD COLUMN `ENTITLED_APPS` varchar(255);
    UPDATE `TENANT` SET ENTITLED_APPS="Lattice";

    CREATE TABLE `STRING_TEMPLATE` (
          `PID` bigint(20) NOT NULL AUTO_INCREMENT,
          `NAME` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
          `TEMPLATE` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
          PRIMARY KEY (`PID`),
          UNIQUE KEY `UK32mlafkdqky1cgch77plnbrir` (`NAME`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

    ALTER TABLE `PLS_MultiTenant`.`ACTIVITY_METRIC_GROUP`
            CHANGE COLUMN `DESCRIPTION_TMPL` `DESCRIPTION_TMPL` BIGINT(20) NULL DEFAULT NULL ,
            CHANGE COLUMN `DISPLAY_NAME_TMPL` `DISPLAY_NAME_TMPL` BIGINT(20) NOT NULL ,
            CHANGE COLUMN `SUBCATEGORY_TMPL` `SUBCATEGORY_TMPL` BIGINT(20) NOT NULL ;
            ALTER TABLE `PLS_MultiTenant`.`ACTIVITY_METRIC_GROUP`
            ADD CONSTRAINT `DISPLAY_NAME_TMPL`
              FOREIGN KEY (`DISPLAY_NAME_TMPL`)
              REFERENCES `PLS_MultiTenant`.`STRING_TEMPLATE` (`PID`)
              ON DELETE NO ACTION
              ON UPDATE NO ACTION,
            ADD CONSTRAINT `DESCRIPTION_TMPL`
              FOREIGN KEY (`DESCRIPTION_TMPL`)
              REFERENCES `PLS_MultiTenant`.`STRING_TEMPLATE` (`PID`)
              ON DELETE NO ACTION
              ON UPDATE NO ACTION,
            ADD CONSTRAINT `SUBCATEGORY_TMPL`
              FOREIGN KEY (`SUBCATEGORY_TMPL`)
              REFERENCES `PLS_MultiTenant`.`STRING_TEMPLATE` (`PID`)
              ON DELETE NO ACTION
              ON UPDATE NO ACTION;
END;
//
DELIMITER;

CALL `UpdatePLSTables`();
