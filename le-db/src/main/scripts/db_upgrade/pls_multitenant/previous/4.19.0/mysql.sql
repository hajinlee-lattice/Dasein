USE `PLS_MultiTenant`;

CREATE PROCEDURE `UpdatePLSTables`()
  BEGIN

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH_CHANNEL` c
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON c.FK_CURRENT_LAUNCHED_ACCOUNT_UNIVERSE_TABLE = t.PID
        SET c.CURRENT_LAUNCHED_ACCOUNT_UNIVERSE_TABLE_ID = t.NAME;

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH_CHANNEL` c
        JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON c.FK_CURRENT_LAUNCHED_CONTACT_UNIVERSE_TABLE = t.PID
    SET c.CURRENT_LAUNCHED_CONTACT_UNIVERSE_TABLE_ID = t.NAME;

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH_CHANNEL` SET EXPIRATION_DATE = (SELECT DATE_ADD(NOW(), INTERVAL 6 MONTH))
    	WHERE ALWAYS_ON = 1 AND EXPIRATION_DATE IS NULL AND PID>0;

    ALTER TABLE `PLS_MultiTenant`.`PLAY_LAUNCH`
        ADD COLUMN `ADD_ACCOUNTS_TABLE_NAME` VARCHAR(255),
        ADD COLUMN `ADD_CONTACTS_TABLE_NAME` VARCHAR(255),
        ADD COLUMN `REMOVE_ACCOUNTS_TABLE_NAME` VARCHAR(255),
        ADD COLUMN `REMOVE_CONTACTS_TABLE_NAME` VARCHAR(255),
        ADD COLUMN `AUDIENCE_SIZE` BIGINT,
        ADD COLUMN `MATCHED_COUNT` BIGINT;

    ALTER TABLE `PLS_MultiTenant`.`ATLAS_EXPORT`
		ADD COLUMN `FILES_TO_DELETE` JSON,
		ADD COLUMN `CREATED` DATETIME NOT NULL DEFAULT '1970-01-01 00:00:00',
		ADD COLUMN `UPDATED` DATETIME NOT NULL DEFAULT '1970-01-01 00:00:00';

    ALTER TABLE PLS_MultiTenant.ATLAS_S3_IMPORT_SYSTEM
     ADD COLUMN SECONDARY_ACCOUNT_IDS JSON,
     ADD COLUMN SECONDARY_CONTACT_IDS JSON;

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH` l
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON l.FK_ADD_ACCOUNTS_TABLE = t.PID
        SET l.ADD_ACCOUNTS_TABLE_NAME = t.NAME;

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH` l
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON l.FK_ADD_CONTACTS_TABLE = t.PID
        SET l.ADD_CONTACTS_TABLE_NAME = t.NAME;

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH` l
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON l.FK_REMOVE_ACCOUNTS_TABLE = t.PID
        SET l.REMOVE_ACCOUNTS_TABLE_NAME = t.NAME;

    UPDATE `PLS_MultiTenant`.`PLAY_LAUNCH` l
            JOIN `PLS_MultiTenant`.`METADATA_TABLE` t ON l.FK_REMOVE_CONTACTS_TABLE = t.PID
        SET l.REMOVE_CONTACTS_TABLE_NAME = t.NAME;

    ALTER TABLE `PLS_MultiTenant`.`METADATA_DATA_COLLECTION_TABLE`
        ADD COLUMN `SIGNATURE` VARCHAR(255) NULL DEFAULT NULL AFTER `ROLE`,
        ADD UNIQUE KEY `UK_COLLECTION_ROLE_VERSION_SIGNATURE` (`FK_COLLECTION_ID`, `ROLE`, `VERSION`, `SIGNATURE`);

    CREATE TABLE `PLS_MultiTenant`.`ATLAS_CATALOG`
    (
        `PID`          BIGINT                                  NOT NULL AUTO_INCREMENT,
        `NAME`         VARCHAR(255) COLLATE utf8mb4_unicode_ci NOT NULL,
        `CREATED`      DATETIME                                NOT NULL,
        `UPDATED`      DATETIME                                NOT NULL,
        `FK_TENANT_ID` BIGINT(20)                              NOT NULL,
        `FK_TASK_ID`   BIGINT(20)                              NOT NULL,
        PRIMARY KEY (`PID`),
        KEY `FK_TENANT_ID` (`FK_TENANT_ID`),
        KEY `FK_TASK_ID` (`FK_TASK_ID`),
        UNIQUE KEY `UK_NAME_TENANT` (`NAME`, `FK_TENANT_ID`),
        UNIQUE KEY `UK_TASK_TENANT` (`FK_TASK_ID`, `FK_TENANT_ID`),
        CONSTRAINT `CATALOG_FK_TENANT` FOREIGN KEY (`FK_TENANT_ID`) REFERENCES `TENANT` (`TENANT_PID`) ON DELETE CASCADE,
        CONSTRAINT `CATALOG_FK_DATAFEED_TASK` FOREIGN KEY (`FK_TASK_ID`) REFERENCES `DATAFEED_TASK` (`PID`) ON DELETE CASCADE
    ) engine=InnoDB;

    UPDATE `PLS_MultiTenant`.`TENANT` SET `NOTIFICATION_TYPE` = 'SINGLE_USER' WHERE (`TENANT_PID` = '13586' AND `NAME`
    = 'Akamai_Atlas_v2');

  END;
//
DELIMITER;

CALL `UpdatePLSTables`();

CALL `CreatePlayChannels`();

CALL `AttachPlayChannelsToPlayLaunch`();
