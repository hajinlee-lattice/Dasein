{
  "AWS::CloudFormation::Init": {
    "configSets": {
      "bootstrap": [
        "prepare",
        "install"
      ]
    },
    "prepare": {
      "files": {
        "/tmp/zkserver-head.txt": {
          "content": {
            "Fn::Join": [
              "\n",
              [ "#!/usr/bin/env bash",
                "# description: Zookeeper Start Stop Restart",
                "# processname: zookeeper",
                "# chkconfig: 244 30 80",
                "ZOO_LOG_DIR=/var/log/zookeeper"
              ]
            ]
          },
          "mode": "000777",
          "owner": "root",
          "group": "root"
        },
        "/tmp/bootstrap_zk.sh": {
          "content": {
            "Fn::Join": [
              "\n",
              [ "#!/usr/bin/env bash",
                "wget http://apache-mirror.rbc.ru/pub/apache/zookeeper/zookeeper-3.4.6/zookeeper-3.4.6.tar.gz",
                "tar xzf zookeeper-3.4.6.tar.gz",
                "cp zookeeper-3.4.6/bin/zkServer.sh .",
                "sed -i '/env bash/d' zkServer.sh",
                "sed -i '/BASH_SOURCE-/ZOOBIN=`readlink $0`/g' zkServer.sh",
                "cat /tmp/zkserver-head.txt zkServer.sh > zookeeper-3.4.6/bin/zkServer.sh",
                "mv zookeeper-3.4.6 /opt",
                "cp /opt/zookeeper-3.4.6/conf/zoo_sample.cfg /opt/zookeeper-3.4.6/conf/zoo.cfg",
                "chmod a+w /opt/zookeeper-3.4.6/conf/zoo.cfg"
              ]
            ]
          },
          "mode": "000777",
          "owner": "root",
          "group": "root"
        },
        "/var/lib/docker/docker.out": {
          "content": "bootstrap",
          "mode": "000777",
          "owner": "root",
          "group": "root"
        },
        "/var/lib/zookeeper/myid": {
          "content": "",
          "mode": "000777",
          "owner": "root",
          "group": "root"
        }
      }
    },
    "install": {
      "commands": {
        "0" : {
          "command" : { "Fn::Join": [ "\n", [
            "#!/bin/bash",
            "ADDR=`ifconfig eth0 | grep 'inet addr:' | cut -d: -f2 | awk '{ print $1}'`",
            "echo $ADDR >> /etc/internaladdr.txt",
            "PUBADDR=`curl http://169.254.169.254/latest/meta-data/public-ipv4`",
            "echo $PUBADDR >> /etc/externaladdr.txt"
          ] ] }
        },
        "1": {
          "command": "yum update -y"
        },
        "2": {
          "command": "bash /tmp/bootstrap_zk.sh"
        },
        "3": {
          "command": "curl -sSL https://get.docker.com/ | sh"
        },
        "4" : {
          "command": "usermod -aG docker ec2-user"
        },
        "5": {
          "command": "service cgconfig start"
        },
        "6": {
          "command": "service docker start"
        },
        "7": {
          "command": "sed -i \"s|exec daemon|exec daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock|g\" /etc/init.d/docker",
          "test": "cat /etc/init.d/docker | grep 2375"
        },
        "8": {
          "command": "service docker restart",
          "test": "ps -aux | grep \"docker daemon\""
        }
      }
    }
  }
}