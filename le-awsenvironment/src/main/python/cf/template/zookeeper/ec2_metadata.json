{
  "AWS::CloudFormation::Init": {
    "configSets": {
      "bootstrap": [
        "prepare",
        "install"
      ]
    },
    "prepare": {
      "packages" : {
        "yum" : {
          "xfsprogs" : []
        }
      },
      "files": {
        "/etc/init.d/zookeeper": {
          "content": "",
          "mode": "000777",
          "owner": "root",
          "group": "root"
        },
        "/tmp/mount_volume.sh": {
          "content": {
            "Fn::Join": [
              "\n",
              [ "#!/usr/bin/env bash",
                "mkdir -p /mnt/zookeeper/data-log",
                "file -s /dev/xvdb",
                "mkfs -t xfs /dev/xvdb",
                "echo '/dev/xvdb       /mnt/zookeeper/data-log   xfs    defaults,nofail        0       2' >> /etc/fstab",
                "mount -a"
              ]
            ]
          },
          "mode": "000777",
          "owner": "root",
          "group": "root"
        },
        "/tmp/0_java.env": {
          "content": {
            "Fn::Join": [
              "\n",
              [ "JVMFLAGS=\"-Xms3g -Xmx3584m\"",
                "ZOO_LOG4J_PROP=\"INFO,ROLLINGFILE\"",
                "ZOO_LOG_DIR=\"/var/log/zookeeper/\""
              ]
            ]
          },
          "mode": "000777",
          "owner": "root",
          "group": "root"
        },
        "/tmp/bootstrap.sh": {
          "content": {
            "Fn::Join": [
              "\n",
              [ "#!/usr/bin/env bash",
                "wget http://mirrors.ocf.berkeley.edu/apache/zookeeper/zookeeper-3.4.8/zookeeper-3.4.8.tar.gz",
                "tar xzf zookeeper-3.4.8.tar.gz",
                "mv zookeeper-3.4.8 /opt/zookeeper",
                "cp /opt/zookeeper/conf/zoo_sample.cfg /opt/zookeeper/conf/zoo.cfg",
                "chmod a+w /opt/zookeeper/conf/zoo.cfg",
                "mv /tmp/0_java.env /opt/zookeeper/conf/java.env",
                "chkconfig zookeeper on"
              ]
            ]
          },
          "mode": "000777",
          "owner": "root",
          "group": "root"
        },
        "/var/lib/zookeeper/myid": {
          "content": "",
          "mode": "000777",
          "owner": "root",
          "group": "root"
        }
      }
    },
    "install": {
      "commands": {
        "0": {
          "command": "bash /tmp/mount_volume.sh"
        },
        "1": {
          "command": "bash /tmp/bootstrap.sh"
        }
      }
    }
  }
}
