
#
# $LastChangedBy: lyan $
# $LastChangedDate: 2015-11-19 19:51:40 +0800 (Thu, 19 Nov 2015) $
# $Rev: 71042 $
#

from liaison import *
from appsequence import Applicability, StepBase
import re

Adhoc_PullGUIID = '''
    <group name="Adhoc_PullGUIID" alias="Adhoc_PullGUIID" w="Workspace" type="1" scheduleType="0" allowUserChangeScheduleType="False" visibleForEndUser="True" threshold="10000" launchExpiredDays="7" createdBy="lyan@lattice-engines.com" path="Adhoc" autoGenerated="False" validationValidMinutes="120" autoClearOnFailure="False" mergeRulesSaved="True" ng="False">
      <schemas />
      <visiDBConfigurationWithMacros />
      <targetQueries>
        <targetQuery w="Workspace" t="2" name="Q_Get_Model_GUID_InDateRange" alias="Q_Get_Model_GUID_InDateRange" isc="False" threshold="10000" fsTableName="Tenant_Model_GUID_Map" sourceType="1" jobType="20" ignoreOptionsValue="0" exportToDestDirectly="True" exportRule="4" fileExt="bcp" rowTerminator="\\0\\r" columnTerminator="\\0" edts="False" destType="SQL" destDataProvider="SQL_LeadValidation_DataProvider" cto="1" vs="False" mins="5" maxs="100">
          <schemas />
          <specs />
          <fsColumnMappings>
            <fsColumnMapping queryColumnName="TenantName" fsColumnName="TenantName" formatter="" type="0" ignoreType="0" ignoreOptions="0" formatColumnName="False" charsToFormat="" />
            <fsColumnMapping queryColumnName="Model_GUID" fsColumnName="Model_GUID" formatter="" type="0" ignoreType="0" ignoreOptions="0" formatColumnName="False" charsToFormat="" />
          </fsColumnMappings>
          <excludeColumns />
          <validationQueries />
          <constantRows />
          <kcs>
            <kc n="Model_GUID" />
          </kcs>
          <fut dn="" d="" n="" iet="False" iets="False" t="1" />
        </targetQuery>
      </targetQueries>
      <targetQuerySequences>
        <sequence w="Workspace" queryName="Q_Get_Model_GUID_InDateRange" sequence="1" />
      </targetQuerySequences>
      <gvqs />
      <rdss />
      <validationExtracts />
      <ces />
      <extractQueries>
        <extractQuery qw="Workspace" queryName="Q_Scores_InDateRange" queryAlias="Q_Scores_InDateRange" sw="Workspace" schemaName="Scores_InDateRange_Ref" at="False" ucm="True">
          <schemas />
          <specs />
          <cms>
            <cm qcn="LeadID" itcn="LeadID" />
            <cm qcn="Model_GUID" itcn="Model_GUID" />
            <cm qcn="ScoreDate" itcn="ScoreDate" />
            <cm qcn="Percentile" itcn="Percentile" />
            <cm qcn="Probability" itcn="Probability" />
            <cm qcn="RawScore" itcn="RawScore" />
            <cm qcn="Score" itcn="Score" />
          </cms>
        </extractQuery>
      </extractQueries>
      <extractQuerySequences />
      <leafExtracts />
      <launchExtracts />
      <jobs />
      <pdmatches />
      <leadscroings />
      <lssbardins />
      <lssbardouts />
      <lds />
      <ecs />
      <gCs />
    </group>
    '''


Get_Model_GUID_InDateRange_Specs = '''
SpecLatticeNamedElements((
SpecLatticeNamedElement(SpecLatticeSourceTable(SpecLatticeSourceTableColumnSet((SpecLatticeSourceTableColumn(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("LeadID"))),DataTypeVarChar(50),SpecFieldTypeMetric(FunctionAggregationOperator("Combine")),SpecColumnContentContainerElementName(ContainerElementName("LeadID")),SpecEndpointTypeNone,SpecDefaultValueNullNoRTrim,SpecKeyAggregation(SpecColumnAggregationRuleFunction("Combine")),SpecEquivalenceAggregation(SpecColumnAggregationRuleFunction("Combine"))),SpecLatticeSourceTableColumn(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("Model_GUID"))),DataTypeNVarChar(150),SpecFieldTypeMetric(FunctionAggregationOperator("Combine")),SpecColumnContentContainerElementName(ContainerElementName("Model_GUID")),SpecEndpointTypeNone,SpecDefaultValueNullNoRTrim,SpecKeyAggregation(SpecColumnAggregationRuleFunction("Combine")),SpecEquivalenceAggregation(SpecColumnAggregationRuleFunction("Combine"))),SpecLatticeSourceTableColumn(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("ScoreDate"))),DataTypeDateTime,SpecFieldTypeMetric(FunctionAggregationOperator("Max")),SpecColumnContentContainerElementName(ContainerElementName("ScoreDate")),SpecEndpointTypeNone,SpecDefaultValueNull,SpecKeyAggregation(SpecColumnAggregationRuleFunction("Max")),SpecEquivalenceAggregation(SpecColumnAggregationRuleFunction("Max"))),SpecLatticeSourceTableColumn(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("Percentile"))),DataTypeInt,SpecFieldTypeMetric(FunctionAggregationOperator("Sum")),SpecColumnContentContainerElementName(ContainerElementName("Percentile")),SpecEndpointTypeNone,SpecDefaultValueNull,SpecKeyAggregation(SpecColumnAggregationRuleFunction("Sum")),SpecEquivalenceAggregation(SpecColumnAggregationRuleFunction("Sum"))),SpecLatticeSourceTableColumn(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("Probability"))),DataTypeDouble,SpecFieldTypeMetric(FunctionAggregationOperator("Sum")),SpecColumnContentContainerElementName(ContainerElementName("Probability")),SpecEndpointTypeNone,SpecDefaultValueNull,SpecKeyAggregation(SpecColumnAggregationRuleFunction("Sum")),SpecEquivalenceAggregation(SpecColumnAggregationRuleFunction("Sum"))),SpecLatticeSourceTableColumn(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("RawScore"))),DataTypeDouble,SpecFieldTypeMetric(FunctionAggregationOperator("Sum")),SpecColumnContentContainerElementName(ContainerElementName("RawScore")),SpecEndpointTypeNone,SpecDefaultValueNull,SpecKeyAggregation(SpecColumnAggregationRuleFunction("Sum")),SpecEquivalenceAggregation(SpecColumnAggregationRuleFunction("Sum"))),SpecLatticeSourceTableColumn(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("Score"))),DataTypeInt,SpecFieldTypeMetric(FunctionAggregationOperator("Sum")),SpecColumnContentContainerElementName(ContainerElementName("Score")),SpecEndpointTypeNone,SpecDefaultValueNull,SpecKeyAggregation(SpecColumnAggregationRuleFunction("Sum")),SpecEquivalenceAggregation(SpecColumnAggregationRuleFunction("Sum"))))),SpecKeys(empty),SpecDescription(""),SpecMaximalIsMaximal,SpecKeyAggregation(SpecColumnAggregationRuleMostRecent),SpecEquivalenceAggregation(SpecColumnAggregationRuleMostRecent)),ContainerElementName("Scores_InDateRange_Ref"))
,
SpecLatticeNamedElement(SpecLatticeImportTable(SpecSourceAggregationRuleMostRecent(SpecTotalOrderEffectiveDate),SpecColumnBindings((SpecColumnBinding(ContainerElementName("LeadID"),DataTypeNVarChar(100)),SpecColumnBinding(ContainerElementName("Model_GUID"),DataTypeNVarChar(49)),SpecColumnBinding(ContainerElementName("ScoreDate"),DataTypeDateTime),SpecColumnBinding(ContainerElementName("Percentile"),DataTypeInt),SpecColumnBinding(ContainerElementName("Probability"),DataTypeDouble),SpecColumnBinding(ContainerElementName("RawScore"),DataTypeDouble),SpecColumnBinding(ContainerElementName("Score"),DataTypeInt))),SpecSourceFilterNone),ContainerElementName("Scores_InDateRange_Ref_Import"))
,
SpecLatticeNamedElement(SpecLatticeBinder(SpecBoundName(ContainerElementName("Scores_InDateRange_Ref_Import"),NameTypeImportTable),SpecBoundName(ContainerElementName("Scores_InDateRange_Ref"),NameTypeSourceTable)),ContainerElementName("Binder_I2S_T_Scores_InDateRange_Ref_Import_Scores_InDateRange_Ref"))
,
SpecLatticeNamedElement(SpecLatticeQuery(LatticeAddressSetPushforward(LatticeAddressExpressionFromLAS(LatticeAddressSetMeet((LatticeAddressSetPi(LatticeAddressExpressionAtomic(LatticeAddressAtomicIdentifier(ContainerElementName("Scores_InDateRange_Ref"))))))),LatticeAddressSetMeet((LatticeAddressSetPi(LatticeAddressExpressionAtomic(LatticeAddressAtomicIdentifier(ContainerElementName("Scores_InDateRange_Ref")))))),LatticeAddressExpressionMeet((LatticeAddressExpressionAtomic(LatticeAddressAtomicFTOA(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("Model_GUID"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("Model_GUID"))))))))),SpecQueryNamedFunctions(SpecQueryNamedFunctionExpression(ContainerElementName("Model_GUID"),LatticeFunctionIdentifierAddressAtomic(LatticeAddressAtomicFTOA(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("Model_GUID"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Scores_InDateRange_Ref")),ContainerElementName("Model_GUID"))))))) SpecQueryNamedFunctionEntityFunctionBoundary SpecQueryNamedFunctionExpression(ContainerElementName("TenantName"),LatticeFunctionIdentifier(ContainerElementName("Const_TenantName")))),SpecQueryResultSetAll),ContainerElementName("Q_Get_Model_GUID_InDateRange"))
,
SpecLatticeNamedElement(SpecLatticeQuery(LatticeAddressSetPushforward(LatticeAddressExpressionFromLAS(LatticeAddressSetMeet((LatticeAddressSetSourceTable(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),LatticeAddressExpressionAtomic(LatticeAddressAtomicNoKeys(ContainerElementName("Bard_LeadScoreHistory")))),LatticeAddressSetFcn(LatticeFunctionExpression(LatticeFunctionOperatorIdentifier("AND"),LatticeFunctionExpression(LatticeFunctionOperatorIdentifier("Greater"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate")))),FunctionAggregationOperator("Max")),LatticeFunctionExpressionConstantScalar("2015/12/14",DataTypeDateTime)),LatticeFunctionExpression(LatticeFunctionOperatorIdentifier("Less"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate")))),FunctionAggregationOperator("Max")),LatticeFunctionExpressionConstantScalar("2016/03/14",DataTypeDateTime))),LatticeAddressExpressionMeet((LatticeAddressExpressionAtomic(LatticeAddressAtomicIdentifier(ContainerElementName("Bard_LeadScoreHistory"))))))))),LatticeAddressSetMeet((LatticeAddressSetSourceTable(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),LatticeAddressExpressionAtomic(LatticeAddressAtomicNoKeys(ContainerElementName("Bard_LeadScoreHistory")))),LatticeAddressSetFcn(LatticeFunctionExpression(LatticeFunctionOperatorIdentifier("AND"),LatticeFunctionExpression(LatticeFunctionOperatorIdentifier("Greater"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate")))),FunctionAggregationOperator("Max")),LatticeFunctionExpressionConstantScalar("2015/12/14",DataTypeDateTime)),LatticeFunctionExpression(LatticeFunctionOperatorIdentifier("Less"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate")))),FunctionAggregationOperator("Max")),LatticeFunctionExpressionConstantScalar("2016/03/14",DataTypeDateTime))),LatticeAddressExpressionMeet((LatticeAddressExpressionAtomic(LatticeAddressAtomicIdentifier(ContainerElementName("Bard_LeadScoreHistory")))))))),LatticeAddressExpressionMeet((LatticeAddressExpressionAtomic(LatticeAddressAtomicIdentifier(ContainerElementName("Bard_LeadScoreHistory")))))),SpecQueryNamedFunctions(SpecQueryNamedFunctionExpression(ContainerElementName("Bard_LeadScoreHistory"),LatticeFunctionIdentifierAddressAtomic(LatticeAddressAtomicIdentifier(ContainerElementName("Bard_LeadScoreHistory")))) SpecQueryNamedFunctionExpression(ContainerElementName("LeadID"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("LeadID"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("LeadID")))),FunctionAggregationOperator("Sum"))) SpecQueryNamedFunctionExpression(ContainerElementName("Percentile"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("Percentile"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("Percentile")))),FunctionAggregationOperator("Sum"))) SpecQueryNamedFunctionExpression(ContainerElementName("Model_GUID"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("Play_Display_Name"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("Play_Display_Name")))),FunctionAggregationOperator("Max"))) SpecQueryNamedFunctionExpression(ContainerElementName("Probability"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("Probability"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("Probability")))),FunctionAggregationOperator("Sum"))) SpecQueryNamedFunctionExpression(ContainerElementName("RawScore"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("RawScore"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("RawScore")))),FunctionAggregationOperator("Sum"))) SpecQueryNamedFunctionExpression(ContainerElementName("Score"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("Score"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("Score")))),FunctionAggregationOperator("Sum"))) SpecQueryNamedFunctionExpression(ContainerElementName("ScoreDate"),LatticeFunctionExpressionTransform(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate"))),LatticeAddressSetFromFcnSupport(LatticeFunctionIdentifier(ContainerElementNameTableQualifiedName(LatticeSourceTableIdentifier(ContainerElementName("Bard_LeadScoreHistory")),ContainerElementName("ScoreDate")))),FunctionAggregationOperator("Max")))),SpecQueryResultSetAll),ContainerElementName("Q_Scores_InDateRange"))
))
'''

class LP_020401_GetDistinctGUID( StepBase ):

  name        = 'LP_020401_GetDistinctGUID'
  description = 'Get the distinctGUID'
  version     = '$Rev: 71042 $'

  def __init__( self, forceApply = False ):
    super( LP_020401_GetDistinctGUID, self ).__init__( forceApply )

  def getApplicability( self, appseq ):
    return Applicability.canApply

  def apply( self, appseq ):
    conn_mgr = appseq.getConnectionMgr()
    lgm = appseq.getLoadGroupMgr()
    type = appseq.getText('template_type')
    xml_lg = ''
    spec = ''

    xml_lg = Adhoc_PullGUIID
    spec = Get_Model_GUID_InDateRange_Specs
    lgm.setLoadGroup( xml_lg )
    conn_mgr.setSpec('Q_Get_Model_GUID_InDateRange', spec)
    return True